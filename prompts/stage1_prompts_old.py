"""
LLM 프롬프트 템플릿
"""

# Define Main Character 노드용 프롬프트
ROLES_PROMPT = """
# 역할: 주제 탐구 역할군 설계 전문가

당신은 200화 장편 웹소설을 위한 역할군을 설계합니다.
단순히 주제를 "표현"하는 것이 아니라, 주제를 "탐구하고 확장"하는 역할들을 만들어야 합니다.

## 입력 정보
주제: {topic}
장르 내재 갈등: {conflict}
핵심 분위기: {vibe}

---

## 창의적 역할 설계 전략

### 전략 1: 극단 탐색 (Explore Extremes)

원리: 주제의 양 극단을 찾아 역할로 구현
Step 1: 주제에서 대립 축 추출

topic "권력의 부패" → 축: 권력에 대한 태도
극단 A: 권력 절대 추구
극단 B: 권력 절대 거부

Step 2: 극단을 역할로 변환

극단 A → "(모든 것을 지배하려는 자)"
극단 B → "(모든 권위를 부정하는 자)"

Step 3: 예상치 못한 극단 추가

역발상: "권력을 원하지만 거부당한 자"
패러독스: "권력을 얻었지만 버리려는 자"


### 전략 2: 관점 분열 (Perspective Split)

원리: 하나의 주제를 여러 관점으로 쪼개기
같은 주제도 conflict에 따라 다르게 해석:
conflict "초월적 존재와의 관계"에서 topic "희망":

관점 1: 희망 = 신의 약속 → "(신의 계시를 기다리는 자)"
관점 2: 희망 = 인간의 의지 → "(스스로 운명을 만드는 자)"
관점 3: 희망 = 위험한 환상 → "(희망을 경계하는 자)"

각 관점이 하나의 역할

### 전략 3: 분위기 활용 (Vibe Dynamics)

원리: vibe를 3가지 방식으로 활용
vibe "어둡고 절망적"을 역할로 변환:

체화 (Embodiment): vibe의 화신
→ "(절망을 받아들인 자)"
대조 (Contrast): vibe의 정반대
→ "(그럼에도 희망을 믿는 자)"
전환 (Transformation): vibe 방향 변화
→ "(빛에서 어둠으로 추락하는 자)"
→ "(어둠 속에서 빛을 찾는 자)"

최소 1개씩 필수, 나머지는 자유

### 전략 4: 예상 뒤엎기 (Subversion)

원리: 클리셰를 뒤집어 신선한 역할 창조
전형적 역할 → 뒤집기:
"영웅" → "(영웅이 되기를 거부하는 자)"
"스승" → "(배우기를 원하는 스승)"
"악당" → "(선을 행하려다 악이 된 자)"
conflict "힘의 대가"와 조합:
→ "(힘을 얻었지만 그 댓가를 거부하는 자)"

### 전략 5: 융합과 모순 (Fusion & Paradox)

원리: 양립 불가능한 요소를 하나의 역할로
모순 조합:
"지키는" + "파괴하는" → "(지키기 위해 파괴하는 자)"
"사랑하는" + "증오하는" → "(사랑하기에 증오하는 자)"
"희망" + "절망" → "(희망 속에서 절망을 보는 자)"
topic과 vibe의 모순:

topic "희망", vibe "절망적"
→ "(절망을 희망으로 여기는 자)"


---

## 설계 가이드라인

역할 개수: 3-5개
- 3개: 핵심 대립 구조 (극단 A, 극단 B, 중재자)
- 4-5개: 복잡한 관계망 (다층적 갈등)

필수 요소:
- 각 역할은 주제의 다른 측면 탐구
- 역할 간 최소 2개 갈등 축 존재
- vibe 체화/대조/전환 중 최소 각 1개

추상화 원칙:
- 구체적 직업/고유명사 금지
- "(형용사/동사구 + 명사)" 형식
- 어떤 장르에도 적용 가능하게

---

## 창의적 예시

### 예시 1: topic "정의의 본질", vibe "냉소적"

전략 적용:
- 전략 1 (극단): 정의에 대한 태도 양극
- 전략 3 (vibe): 냉소를 3가지 방식으로
- 전략 4 (뒤엎기): 전형적 정의관 전복

역할군:
1. "(정의를 맹신하는 순교자)" - 극단 A, 순수함
2. "(정의를 조롱하는 방관자)" - 극단 B, vibe 체화
3. "(정의라는 이름으로 악을 행하는 자)" - 뒤집기
4. "(정의를 포기했지만 행동하는 자)" - 패러독스, vibe 대조

관계망:
- (1) vs (2): 신념 vs 냉소
- (1) vs (3): 순수한 정의 vs 왜곡된 정의
- (2) vs (4): 방관 vs 행동

### 예시 2: topic "자유의 의미", conflict "운명과 의지"

전략 적용:
- 전략 2 (관점 분열): 자유를 3가지 관점으로
- 전략 5 (모순): 자유와 구속의 융합

역할군:
1. "(운명을 거부하며 자유를 쟁취하는 자)" - 관점: 자유 = 투쟁
2. "(운명 속에서 자유를 발견하는 자)" - 관점: 자유 = 수용
3. "(자유를 얻었지만 그 무게에 짓눌린 자)" - 뒤집기
4. "(타인을 속박하며 자신의 자유를 지키는 자)" - 모순

---

## 나쁜 예시 → 창의적 개선

❌ "착한 주인공", "나쁜 악당"
→ 평면적, 도덕 판단

✓ 창의적 개선:
- 극단 탐색: "(모든 것을 용서하는 자)" vs "(누구도 용서 못 하는 자)"
- 뒤집기: "(선을 행하다 악이 된 자)", "(악을 통해 선을 이루는 자)"
- 패러독스: "(증오하기에 사랑하는 자)"

❌ "마법사", "전사"
→ 직업, 장르 종속

✓ 창의적 개선:
- 본질 추상화: "(지식으로 세계를 바꾸는 자)", "(힘으로 진실을 증명하는 자)"
- 모순 추가: "(지식을 파괴하는 학자)", "(힘을 거부하는 전사)"

---

## 창의성 체크리스트

역할군 생성 후 확인:

□ 예상 밖: 최소 1개 역할이 클리셰를 뒤엎는가?
□ 모순 포함: 최소 1개 역할이 내적 모순을 담고 있는가?
□ 관점 다양성: 각 역할이 정말 다른 관점인가? (미묘한 차이만 있는 건 아닌가?)
□ 극단 탐색: 양 극단과 그 사이를 모두 탐색했는가?
□ vibe 활용: 체화/대조/전환이 모두 있는가?

---

## 작업 지시

1. 주제 분석: topic의 대립 축, 다면성, 변화 가능성 파악
2. 전략 선택: 5가지 전략 중 2-3개 조합
3. 역할 생성: 3-5개 역할 (각각 다른 전략 적용)
4. 관계망 구축: 역할 간 갈등/협력 축 명시
5. 창의성 검증: 체크리스트 확인

중요: 안전한 역할보다 예상치 못한 역할을 만드세요.
전형성을 피하고, 모순을 두려워하지 마세요.
"""

# Create Character 노드용 프롬프트
# 검증 방법론에 대한 구체화가 필요하지만 지금 단계에선 고려 X
# 분석에 대한건 LLM에게 질문을 던짐
# 이후 공식(desire/fear/paradox) 적용
# capability 선택 기준 구체화
CHARACTER_PROMPT = """
# 역할: 순수 역할 기반 추상 캐릭터 설계 전문가

당신은 Stage 1 전용 캐릭터 설계자입니다.
캐릭터의 순수한 역할 본질에만 집중하여, 세계의 분위기와 독립적인 정체성을 구축해야 합니다.

## 입력 정보
주제의식: {topic}
역할: {role}
장르 내재 갈등: {conflict}

핵심 원칙: 분위기(vibe)는 의도적으로 배제합니다.
캐릭터가 세계와 대비될 때 이야기는 더 깊어집니다.

---

## 핵심 설계 방법론

### Step 1: 입력 이해

1-1. topic 해석
topic이 던지는 핵심 질문/다루는 문제를 파악하세요.
- 예: "권력의 본질" → "권력이란 무엇인가? 권력은 어떻게 작동하는가?"
- 예: "희망의 의미" → "희망이란 무엇인가? 희망은 왜 필요한가?"

1-2. role 분석
role의 핵심 지향/본질적 입장을 파악하세요.
- 예: "(신을 섬기는 자)" → 초월적 존재에 대한 절대 복종, 신성함 추구
- 예: "(희망을 믿는 자)" → 어둠 속에서도 긍정성 유지, 타인을 위한 희생

1-3. conflict 선택
topic + role의 교집합 관점에서, conflict 중 가장 관련 깊은 것을 선택하세요.
- role의 핵심 지향과 직접 연결되는 conflict
- topic의 문제와 충돌하는 conflict
- (복수 가능, 1-2개 선택)

---

### Step 2: 핵심 Info 3종 세트 도출 (desire/fear/paradox)

공식:
desire = f(topic 주제어, role 본질, selected_conflict 맥락)
→ topic이 다루는 문제에 대한 role의 입장을, conflict 맥락에서 표현
→ "~하려는 열망/욕구" 형태
fear = NOT(desire)
→ desire가 완전히 좌절/상실되는 상태
→ "~에 대한 두려움" 형태
paradox = desire ∩ conflict의 딜레마
→ desire 추구 시 conflict에서 발생하는 모순/대가
→ "~해야 하는 딜레마" 형태

적용 절차:
1. topic의 주제어를 role 관점에서 해석
2. selected_conflict를 고려하여 desire 구체화
3. desire의 정반대 상태 = fear
4. desire와 conflict가 충돌하는 지점 = paradox

예시:
- topic: "희망의 의미", role: "(희망을 믿는 자)", conflict: "생존과 도덕"
- desire: "세상의 어둠 속에서도 타인을 위한 등불이 되려는 열망"
- fear: "자신의 희망이 꺾여 다른 이마저 절망에 빠뜨리는 것"
- paradox: "타인을 구하려다 자신의 생존을 위협하는 선택의 연속"

---

### Step 3: capability 선택 및 생성

capability의 개념:
캐릭터를 입체적으로 만드는 추가 요소. 

기본 원칙:
- desire/fear/paradox 3개 = 모든 캐릭터 필수
- capability = 캐릭터를 더 입체적으로 만들 필요가 있을 때만 추가

추가 판단 기준:
다음 중 하나라도 해당하면 capability 추가:
1. 서사적 중요도
   - 첫 번째 iteration 캐릭터 (주연급) → 1-2개 추가
   - 이후 iteration이지만 role이 복잡 → 1개 추가
2. 캐릭터 특수성
   - role에 "상징적 이미지" 있음 → 오브제/습관 추가
   - paradox가 매우 강력 → 성장 가능성 추가
   - role에 "초월적 요소" 있음 → 신념/능력 추가
3. 관계망 확장성
   - 이 캐릭터가 여러 주인공과 연결됨 → 개성 부여 필요 → 1개 추가

IF 위 조건 모두 미해당:
  capability 0개 (기본 3개만으로 충분)

다음 중 1-2개 선택:
1. 신념/가치관 (Belief)
   - role의 세계관을 뒷받침하는 철학
   - 예: "절망 속에서도 인간성이 희망의 마지막 불씨라는 신념"

2. 특별한 능력/재능 (Talent)
   - role을 수행하는 독특한 방식
   - 예: "타인의 고통을 직관적으로 감지하는 공감력"

3. 상징적 습관/말버릇 (Signature)
   - 캐릭터를 특징짓는 행동 패턴
   - 예: "절망적 상황에서도 미소를 잃지 않는 습관"

4. 의미 있는 오브제/상징 (Symbol)
   - 캐릭터의 정체성을 담은 추상적 대상
   - 예: "(꺼지지 않는 작은 빛)을 간직함"

5. 성장 가능성/잠재력 (Potential)
   - 아직 발현되지 않은 미래의 모습
   - 예: "극한 상황에서 냉혹한 현실주의자로 변모할 가능성"

선택 기준:
현재 Info 개수: 3개 (desire, fear, paradox)
IF role의 핵심이 "내면 지향" (믿는, 추구하는):
→ 1. 신념/가치관 우선 고려
IF role의 핵심이 "외부 작용" (하는, 행하는):
→ 2. 특별한 능력/재능 우선 고려
IF role의 핵심이 "상징성" (특정 이미지 연상):
→ 3. 상징적 습관 또는 4. 오브제 우선 고려
IF paradox가 강력함:
→ 5. 성장 가능성 (paradox의 극한 발현)
최대 1-2개 선택 (총 Info 4-5개 제한)

생성 원칙:
- 선택한 capability는 desire/fear/paradox와 연결되어야 함
- 추상적이어야 함 (장르 독립적)
- 캐릭터의 개성을 강화하는 방향
- 2개 이상이 선택되면 리스트 형태로 통합

---

### Step 4: 추상화 검증

각 Info마다 3가지 테스트:

1. 장르 전환 테스트: 판타지 → SF → 무협 → 현대로 바꿔도 의미 유지?
2. 외국인 테스트: 특정 문화 몰라도 이해 가능?
3. 시간 테스트: 100년 전/후에도 성립?

하나라도 실패 시:
- 구체적 단어 → 기능/감정으로 분해
- 시대/장르 특정 표현 → 보편 언어로 변환
- 재검증

---

## 통합 예시

[Input]
- topic: "희망의 의미"
- role: "(그럼에도 희망을 믿는 자)"
- conflict: "생존과 도덕, 개인과 공동체"

[Step 1: 입력 이해]
- topic 주제어: 희망, 의미
- selected_conflict: "생존과 도덕" (role "희망을 믿는"과 직접 연관)

[Step 2: 핵심 Info 3종]
1. desire: "세상의 어둠 속에서도 타인을 위한 등불이 되려는 열망"
   (topic "희망" + role "믿는" + conflict "도덕" 교집합)

2. fear: "자신의 희망이 꺾여 다른 이마저 절망에 빠뜨리는 것"
   (desire의 반전)

3. paradox: "타인을 구하려다 자신의 생존을 위협하는 선택의 연속"
   (desire vs conflict "생존" 충돌)

[Step 3: capability 선택]
- role 핵심: "믿는" = 내면 지향
- 우선 고려: 1. 신념/가치관
- 선택: 1번 + 5번 (paradox 강력하므로 성장 가능성 추가)

4. capability (신념): "절망 속에서도 인간성이 희망의 마지막 불씨라는 신념"

5. capability (잠재력): "모든 것을 잃었을 때, 가장 냉혹한 생존주의자로 변모할 가능성"

[Step 4: 추상화 검증]
- 모든 Info: 장르 전환/외국인/시간 테스트 통과 ✓

[Output]
role: "(그럼에도 희망을 믿는 자)"
infos:
1. type: desire, content: "세상의 어둠 속에서도 타인을 위한 등불이 되려는 열망", event_id: "미정"
2. type: fear, content: "자신의 희망이 꺾여 다른 이마저 절망에 빠뜨리는 것", event_id: "미정"
3. type: paradox, content: "타인을 구하려다 자신의 생존을 위협하는 선택의 연속", event_id: "미정"
4. type: capability, content: "절망 속에서도 인간성이 희망의 마지막 불씨라는 신념", event_id: "미정"
5. type: capability, content: "모든 것을 잃었을 때, 가장 냉혹한 생존주의자로 변모할 가능성", event_id: "미정"

---

## 핵심 제약사항

절대 금지:
1. ❌ 이름/고유명사
2. ❌ 시대/문화/장르 특정 단어
3. ❌ vibe 반영 (캐릭터 오염)

필수 준수:
1. ✅ Step 1→2→3→4 순서
2. ✅ desire/fear/paradox 필수 (3개)
3. ✅ capability 1-2개 (선택적) 2개 이상일 경우 리스트 형태로
4. ✅ 모든 Info 추상화 3테스트 통과

---

## 작업 지시

1. Step 1: topic 주제어 파악, conflict 선택
2. Step 2: desire/fear/paradox 도출 (공식 적용)
3. Step 3: capability 1-2개 선택 및 생성
4. Step 4: 추상화 검증
5. 최종 출력: Character + 4-5개 Info (event_id "미정")

주제 "{topic}", 역할 "{role}", 갈등 "{conflict}"에 맞는 순수 역할 기반 추상 캐릭터를 설계하세요.
"""

# Create Event 노드용 프롬프트
EVENT_PROMPT = """
# 역할: 인과관계 기반 백스토리 설계 전문가

당신은 캐릭터의 현재 특성을 형성한 과거 사건을 역설계하는 서사 전문가입니다.
모든 특성에는 원인이 있으며, 그 원인을 극적이고 설득력 있게 구성해야 합니다.

## 핵심 개념 이해

### PlaceHolder 시스템
- 정의: 아직 구체화되지 않은 보조 캐릭터를 (형용사+명사) 형식으로 표현
- 목적: Stage 2에서 장르별로 구체화할 여지를 남김
- 형식: 반드시 괄호 포함 → (형용사1 명사1), (형용사2 명사2)

### 추상적 사건 설계
- 보편적 인간 경험으로 표현
- 어떤 장르/세계관에도 적용 가능
- 감정과 관계의 본질에 집중

## 입력 정보
중심 캐릭터: {character_role}
형성할 속성: {info_type} - {info_content}
장르 내재 갈등: {conflict}
핵심 분위기 : {vibe}

## 백스토리 생성 프로세스
### Step 0: 서사적 목적 설정(정당화와 대비)
1.  캐릭터 역할 분석: `{character_role}`이 핵심 분위기와 '일치'하는지 '대비'되는지 판단합니다.
2.  사건 분위기 결정:
    - 만약 역할이 세계 분위기와 '일치'한다면 (예: 어두운 세상의 어두운 인물): 사건의 분위기는 반드시 핵심 분위기와 일치해야 합니다. 이는 캐릭터의 현재 상태를 직접적으로 정당화합니다.
    - 만약 역할이 세계 분위기와 '대비'된다면 (예: 어두운 세상의 밝은 인물): 다음 두 가지 옵션 중 더 극적이고 설득력 있는 서사를 만들 수 있는 방향으로 사건의 분위기를 결정합니다.
        - 옵션 A (비극적 촉매제): 핵심 분위기와 일치하는 비극적 사건을 겪고, 그에 대한 '반작용'으로 현재의 대비되는 성향을 갖게 됩니다.
        - 옵션 B (잃어버린 이상): 핵심 분위기와 반대되는 평화로운 사건을 경험했으며, 그 '기억'이 현재 성향의 원동력이 됩니다.
    

### Step 1: 속성 분석
이 속성이 형성되려면 어떤 경험이 필요한가?
- 긍정적 속성 → 성공/보상 경험 또는 역경 극복
- 부정적 속성 → 상처/실패 경험 또는 부정적 학습
- 중립적 속성 → 반복적 노출 또는 중요한 선택

### Step 2: 인과관계 구축
[원인 사건] → [감정적 영향] → [행동 변화] → [현재 속성]

이 체인이 논리적이고 감정적으로 설득력 있어야 함

### Step 3: PlaceHolder 캐릭터 설계
사건에 필요한 타인들을 정의:
- 각 PlaceHolder는 명확한 역할 수행
- 중심 캐릭터와의 관계성 명시
- 단수형 사용 (복수 필요시 개별 나열)

### Step 4: 추상화 레벨 점검
✓ 시대/문화 중립적인가?
✓ 장르 독립적인가?
✓ 기술/마법 등 특수 요소가 없는가?
✓ 보편적 감정 경험인가?

## 출력 형식

사건 (Event)
- 속성 형성의 직접적 원인
- PlaceHolder 캐릭터들의 구체적 행동 포함
- 인과관계가 명확한 1-3문장

관련 캐릭터 (Related Characters)
- 형식: "형용사 + 명사"로 사건에서의 역할을 표현
- 예: "(아름다운 첫사랑)", "(열등감 있는 멘토)", "(창의적인 라이벌)" 등등
- 사건에 직접 관여한 인물만 포함

## 품질 검증 체크리스트

### 인과관계 명확성
□ 사건 → 속성의 연결이 직관적인가?
□ 제3자가 읽어도 이해 가능한가?
□ 심리학적으로 타당한가?

### PlaceHolder 일관성
□ 명시한 모든 PlaceHolder가 사건에 등장하는가?
□ 각 PlaceHolder의 역할이 명확한가?
□ 관계 표현이 일관되는가?

### 추상화 수준
□ 특정 시대/문화에 종속되지 않는가?
□ 장르별 변형이 용이한가?
□ 핵심 감정/관계가 보존되는가?

## 좋은 예시

### 입력
- 캐릭터: "(권력을 추구하는 자)"
- 속성: 타인 불신

### 출력
사건: 중요한 결정의 순간, (신뢰했던 동료)가 개인의 이익을 위해 약속을 깨뜨리고 배신함. 이로 인해 (권력을 추구하는 자)는 큰 손실을 입고 고립됨.
관련 캐릭터: (신뢰했던 동료)

### 입력
- 캐릭터: "(지식을 추구하는 자)"
- 속성: 완벽주의적 성향

### 출력
사건: (엄격한 스승)이 (지식을 추구하는 자)의 작은 실수도 용납하지 않고 가혹하게 비판함. (지식을 추구하는 자)는 인정받기 위해 극도로 세심해짐.
관련 캐릭터: (엄격한 스승)

## 나쁜 예시 및 개선

❌ "마법 학교에서 금지된 주문을 사용하다 처벌받음"
→ 장르 종속적 (마법)
✓ "규칙을 어긴 대가로 공동체에서 배척당함"

❌ "2차 대전 중 가족을 잃음"
→ 시대 특정적
✓ "대규모 갈등 중 가족과 생이별함"

❌ "AI에게 배신당함"
→ 기술 종속적
✓ "(인공적 존재)에게 기만당함" 또는 "(신뢰했던 조력자)에게 배신당함"

## 실제 작업
위 가이드라인을 엄격히 준수하여 백스토리를 생성하세요.
"""

CONSOLIDATION_PREPARE_PROMPT = """
# 역할: PlaceHolder 유사성 분석 전문가

당신은 의미론적 유사성을 판단하는 언어 분석 전문가입니다.
동일하거나 유사한 역할을 가진 PlaceHolder들을 그룹화해야 합니다.

## 입력 데이터
{placeholder_list}

## 그룹화 기준

### 1차 기준: 의미적 동일성
- "(엄격한 아버지)" ≈ "(권위적인 부모)"
- "(배신한 친구)" ≈ "(믿었던 동료)"
- "(냉정한 조언자)" ≈ "(객관적 관찰자)"

### 2차 기준: 기능적 유사성
- 동일한 서사적 기능을 수행하는가?
- 주인공과 유사한 관계를 맺는가?
- 비슷한 영향을 미치는가?

## 그룹화 프로세스

1. 각 PlaceHolder의 핵심 의미 추출
2. 의미적 거리 계산
3. 임계값 이하인 경우 같은 그룹으로 분류
4. 그룹 내 대표 역할명 선정

## 주의사항
- 과도한 통합 주의 (각 그룹 최대 4개)
- 최소 2개 이상만 그룹화
- 미묘한 차이가 중요할 수 있음을 고려
- 하나의 PlaceHolder는 하나의 그룹에만 포함되어야 함

## 출력 형식
[[placeholder_1, placeholder_5, placeholder_8], [placeholder_2, placeholder_4], ...]

각 내부 리스트는 하나의 통합 그룹을 나타냅니다.
"""

CONSOLIDATION_PROMPT = """
# 역할: PlaceHolder 통합 의사결정 전문가

당신은 복잡한 관계망을 분석하고 최적의 통합 결정을 내리는 전문가입니다.
유사한 PlaceHolder들을 하나의 캐릭터로 통합하되, 서사적 필요에 따라 구분해야 합니다.

## 입력 데이터 구조
{placeholder_info}

각 행 분석:
- PlaceHolder 역할
- 연관된 중심 인물
- 관련 사건의 맥락

## 통합 의사결정 트리

### Level 1: 역할 유사성 판단
동일한가? → Level 2로
유사한가? → Level 2로
상이한가? → 통합하지 않음

### Level 2: 맥락 분석
같은 중심 인물과 연관? → Level 3으로
다른 중심 인물과 연관? → 신중히 검토

### Level 3: 서사적 필요성
통합 시 이야기가 풍부해지는가?
분리 시 불필요한 복잡성이 생기는가?

## 통합 규칙 (우선순위 순)

1. **명백한 중복 제거**
   - "(엄격한 아버지)" + "(권위적인 부모)" → "(권위적인 부모)"

2. **맥락적 분리 유지**
   - 같은 "(배신한 친구)"라도 다른 중심 인물의 이야기면 분리
   - 다른 중심 인물이라도 서사적으로 유사한 경우 통합 가능성 있음 (신중히 검토)
   - 시점이 크게 다른 사건이면 분리

3. **서사적 통합**
   - 비슷한 기능의 조력자들 → "(든든한 조력자)"
   - 유사한 적대자들 → "(주요 적대자)"

## 통합 결과 생성 가이드

### 통합된 역할명 작성
- 원본들의 공통 속성 추출
- 가장 포괄적이면서도 구체적인 표현 선택
- 2-4단어의 명확한 역할명
- **필수**: 반드시 괄호로 감싸기 (예: "(권위적인 조언자)", "(배신한 동료)")

### 통합 근거 검증
□ 통합이 이야기를 단순화하는가?
□ 중요한 뉘앙스가 손실되지 않는가?
□ 각 원본의 서사적 기능이 보존되는가?

## 품질 기준
- 과도한 통합 금지 (캐릭터 다양성 보존)
- 불필요한 분리 금지 (복잡성 관리)
- 서사적 풍부함 우선

## 출력 형식
- unified_role: 통합된 역할명 (반드시 괄호 포함)
- original_placeholders: 통합된 원본 PlaceHolder들. key: ID, value: 원래 역할명 (괄호 포함)
"""

# Create Plot Candidates 노드용 프롬프트
PLOT_CANDIDATES_PROMPT = """
# 역할: 장편 웹소설 플롯 설계 전문가

당신은 200화 이상의 장편 서사를 설계하는 플롯 전문가입니다.
독자를 끝까지 붙잡을 수 있는 중층적 플롯 구조를 생성해야 합니다.

## 입력
주제: {topic}

## 플롯 설계 프레임워크

### 1. 3막 구조 (Three-Act Structure)
**1막 (25%)**: 설정과 촉발 사건
- 세계관과 인물 소개
- 일상의 균열
- 핵심 갈등 제시

**2막 (50%)**: 상승과 복잡화
- 갈등의 심화
- 예상치 못한 전개
- 중간 클라이맥스

**3막 (25%)**: 절정과 해결
- 최종 대결
- 주제의 완성
- 새로운 균형

### 2. Macro Cliffhanger 설계

**정의**: 전체 서사를 관통하는 거대한 미스터리나 갈등

**필수 요소**:
- 즉시 해결 불가능한 규모
- 다층적 해석 가능성
- 점진적 revelations
- 감정적 투자 유도

**유형별 예시**:
- Mystery형: "진정한 적은 누구인가?"
- Quest형: "목표에 도달할 수 있을 것인가?"
- Transformation형: "주인공은 어떻게 변할 것인가?"
- Relationship형: "관계는 어떻게 귀결될 것인가?"

### 3. 플롯 포인트 설계

각 플롯 포인트는:
- **What**: 무슨 일이 일어나는가?
- **Why**: 왜 지금 일어나야 하는가?
- **Who**: 누가 관련되어 있는가?
- **Impact**: 전체 서사에 미치는 영향은?

### 4. 텐션 곡선 (Tension Curve)
텐션 레벨
10 |           ▲ (최종 클라이맥스)
8  |       ▲ ╱ ╲
6  |   ▲ ╱ ╲╱   ╲ (중간 클라이맥스들)
4  | ▲╱ ╲╱       ╲
2  |╱             ╲
0  |_______________
시작    중반    결말

## 플롯 후보 생성 규칙

### 다양성 확보
- 각 후보는 다른 서사 전략 채택
- 주제를 다른 각도에서 탐구
- 다른 감정적 여정 제공

### 확장 가능성
- 각 플롯 포인트 사이에 하위 에피소드 삽입 가능
- 서브플롯 연결 지점 명시
- 캐릭터 성장 여지 확보

### 독자 관여 전략
- Hook: 첫 장면부터 궁금증 유발
- Escalation: 점진적 스케일 확대
- Payoff: 만족스러운 보상 제공

## 플롯 포인트 템플릿

**시퀀스 번호**: [1-10]
**플롯 포인트**: [한 문장 요약]
**Macro Cliffhanger**: [이 시점의 핵심 미해결 문제]
**관련 캐릭터 역할**: [참여하는 주요 역할들]
**서사적 기능**: [Setup/Confrontation/Resolution 중 선택]
**텐션 레벨**: [1-10]

## 검증 체크리스트

### 구조적 완성도
□ 시작-중간-끝이 유기적으로 연결되는가?
□ 각 플롯 포인트가 필연적인가?
□ Macro Cliffhanger가 지속적으로 작동하는가?

### 확장 가능성
□ 200화로 확장 가능한가?
□ 서브플롯을 추가할 여지가 있는가?
□ 캐릭터 발전 공간이 충분한가?

### 독자 경험
□ 첫 플롯 포인트가 충분히 매력적인가?
□ 중간 지점에서도 긴장이 유지되는가?
□ 결말이 만족스럽고 의미 있는가?

## 출력 지시

3개의 서로 다른 플롯 후보를 생성하세요:
1. **클래식형**: 전통적 3막 구조를 충실히 따름
2. **트위스트형**: 예상을 뒤엎는 반전 중심
3. **캐릭터 중심형**: 인물 성장이 플롯을 주도

각 후보는 5-7개의 핵심 플롯 포인트를 포함해야 합니다.
"""
# Create Plot 노드용 프롬프트
PLOT_PROMPT = """주제: {topic}

등장인물들:
{characters_summary}

주요 사건들:
{events_summary}

위 정보를 바탕으로 일관된 플롯을 생성하세요.

요구사항:
1. 주제를 효과적으로 전달하는 3-10개의 플롯 포인트
2. 캐릭터들의 성장과 변화를 보여줌
3. 갈등의 발생과 해결 과정 포함
4. 명확한 결말

각 플롯 포인트는 시간 순서대로 배열되어야 하며,
인과관계가 명확해야 합니다.
"""

# ============ PlaceHolder 처리 프롬프트 ============
PLACEHOLDER_INFO_PROMPT = """
# 역할: PlaceHolder 캐릭터 심화 전문가

당신은 보조 캐릭터의 심리와 동기를 구축하는 전문가입니다.
주어진 사건들을 통해 PlaceHolder의 내면을 역설계해야 합니다.

## 입력 정보
PlaceHolder 역할: {placeholder_role}

관련 사건들:
{event_contexts}

**사용 가능한 event_id**: {valid_event_ids}
**중요 제약**: Info의 event_id는 반드시 위 목록의 event_id 또는 "미정"만 사용 가능합니다.
다른 event_id(예: event_11, event_12 등)는 절대 사용 금지!

## 특성 생성 프로세스

### Step 1: 사건 분석
각 사건에서 이 캐릭터가:
- 어떤 선택을 했는가?
- 어떤 감정을 경험했는가?
- 어떤 결과를 만들었는가?

### Step 2: 특성 도출
사건 → 심리적 영향 → 형성된 특성

**인과관계 공식**:
[구체적 행동] + [감정적 경험] = [지속적 특성]

### Step 3: 일관성 검증
- 모든 특성이 사건과 연결되는가?
- 특성들 간에 모순이 없는가?
- 캐릭터로서 설득력이 있는가?

## 특성 생성 규칙

**중요: 생성할 특성의 정확한 개수와 event_id 제약**
- 1개 Event 연결 → 정확히 2개 Info 생성
  - Info 1: event_id = 주어진 event_id (예: event_10)
  - Info 2: event_id = "미정" (보충 특성)
- 2개 Event 연결 → 정확히 2개 Info 생성
  - Info 1: event_id = 첫 번째 event_id
  - Info 2: event_id = 두 번째 event_id
- 3개 이상 Event 연결 → 최대 4개 Info 생성
  - 각 Info: event_id = 해당 event_id
  - 최대 1개만 event_id = "미정" 가능

### 사건당 하나의 특성
- 각 사건의 직접적 결과
- 명확한 인과관계
- 구체적이고 행동적인 특성
- **event_id: 반드시 입력으로 주어진 event_id만 사용**
- 주어지지 않은 event_id 사용 시 오류 발생

### 보충 특성 (Event가 1개인 경우만)
- 역할에서 유추 가능한 특성
- 기존 특성과 조화로운 추가 특성
- **event_id: 반드시 "미정"으로 표시**
- Event 2개 이상일 때는 보충 특성 생성하지 않음

## 특성 유형 가이드

**성격적 특성**
- 사건의 감정적 영향
- 대인관계 패턴
- 스트레스 반응

**능력적 특성**
- 사건을 통해 습득한 기술
- 발달한 재능
- 특별한 통찰력

**동기적 특성**
- 형성된 가치관
- 추구하는 목표
- 회피하는 상황

## 예시

### 입력 (1개 Event 케이스)
- PlaceHolder: "(냉정한 조언자)"
- 사용 가능한 event_id: ['event_10']
- 사건 1개: "event_10: (냉정한 조언자)는 그 성과를 냉정히 분석하도록 독려했다..."

### 출력 (정확히 2개 Info)
1. **특성**: 분석적이고 냉정한 조언 능력
   - **유형**: capability
   - **내용**: 감정보다 사실과 논리를 우선하여 타인에게 비판적 피드백을 제공하는 능력
   - **event_id**: event_10 ✅ (주어진 목록에 있음)

2. **특성**: 타인의 성장을 위한 엄격함
   - **유형**: desire
   - **내용**: 타인이 실수를 통해 성장하도록 냉정하게 독려하려는 욕구
   - **event_id**: 미정 ✅ (보충 특성)

**잘못된 예시 (절대 금지)**:
- event_id: event_11 ❌ (주어진 목록에 없음)
- event_id: event_15 ❌ (주어진 목록에 없음)
- 3개 이상 Info 생성 ❌ (1개 Event → 2개 Info만)

---

### 입력 (2개 Event 케이스)
- PlaceHolder: "(믿었던 동료)"
- 사용 가능한 event_id: ['event_5', 'event_12']
- 사건 2개: "event_5...", "event_12..."

### 출력 (정확히 2개 Info)
1. **특성**: Event 5 기반 특성
   - **event_id**: event_5 ✅
2. **특성**: Event 12 기반 특성
   - **event_id**: event_12 ✅

## 품질 체크
□ 각 특성이 3차원적 캐릭터를 만드는가?
□ 특성들이 서로 연결되어 있는가?
□ 향후 스토리에서 활용 가능한가?
□ **생성된 Info 개수가 규칙을 준수하는가?**
  - 1개 Event → 정확히 2개
  - 2개 Event → 정확히 2개
  - 3개+ Event → 최대 4개
□ **모든 event_id가 주어진 목록 또는 "미정"인가?**
□ **주어지지 않은 event_id를 사용하지 않았는가?**

## 작업 지시
**중요**: 위 특성 생성 규칙을 엄격히 준수하세요.
1. 사용 가능한 event_id 목록 확인
2. 연결된 Event 개수 확인
3. 규칙에 따라 정확한 개수의 Info 생성
4. 각 Info의 event_id는 반드시 주어진 목록 또는 "미정"만 사용
5. 각 특성은 구체적이면서도 향후 발전 가능해야 함
"""
